{% extends 'easyops/base.html' %}
{% block title %}sql{% endblock %}
{% block body_block %}
<!-- <style type="text/css">
    input[name="sqlstr"] {
        height: 300px;
        word-wrap: break-all;
        word-break: normal;
    }
</style> -->
<style>
	.nav-item>a{
		text-align: center;
		color: gray;
	}
	.nav-item>a:hover{
		background: #e2e2e266;
		color: gray;
	}
	/* .sqlPbiao{
		margin-top: 40px;
		padding-bottom: -25px;
	    color: white;
		text-align: center;
		border-radius: 30px;
		background: #1E90FF;
	} */
	.oButton>button{
		margin-left: 93%;
		margin-top: 0.5%;
		 width: 90px;
		border-radius: 0.25rem;
		border: 1px solid transparent;
		padding: 0.375rem 0.75rem;
		font-size: 1rem;
		line-height: 1.5;
		user-select: none;
		display: inline-block;
		font-weight: 400;
	}
	
</style>
<div class='row' id="app">
    <div class="col-2">
        <ul class="nav nav-pills flex-column">
            {% if perms.easyops.sqlconfig %}
            <li class="list-group-item list-group-item-light nav-item">
                <a class='nav-link' href="#sqls" data-toggle='pill'>
                    sql执行配置
                </a>
            </li>
            {% endif %}
            {% if perms.easyops.sqlexec %}
            {% for sqlstr in sqlstrs %}
            <li class="list-group-item list-group-item-light nav-item left-pane" data-id={{sqlstr.id}}>
                <a class='nav-link' href="#{{sqlstr.dbname}}-{{sqlstr.id}}"
                    data-toggle='pill'>{{sqlstr.dbname}}-{{sqlstr.sqldesc}}</a>
            </li>
            {% endfor %}
            <!-- [[goodname]]
            
            <li v-for="v_sqlstr in v_sqlstrs">
                <a class='nav-link' href="#[[v_sqlstr.dbname]]-[[v_sqlstr.sqlname]]"
                    data-toggle='pill'>[[v_sqlstr.dbname]]-[[v_sqlstr.sqldesc]]</a>
                [[v_sqlstr.sqlstr]]    
            </li>
         
            {% endif %} -->
        </ul>

    </div>
    <div class="col-10">
        <div class="tab-content">
            <div class="tab-pane fade " id="sqls">
                <div id="sqlid">
                </div>
            </div>

            <div class="tab-pane fade" id="dbconnection">
                <div id="dbid" title="dbid">
                </div>
            </div>

            {% if perms.easyops.sqlexec %}
            {% for sqlstr in sqlstrs %}
            <div class="tab-pane fade" id="{{sqlstr.dbname}}-{{sqlstr.id}}">
                <!-- <p>[[v_sqlstrs]]</p> -->
                <p class="list-group-item list-group-item-light" title="{{sqlstr.sqlstr}}">{{sqlstr.sqlstr}}</p>
                {% for arg in sqlstr.args %}
                    <p class="list-group-item list-group-item-light">{{arg}}: <input type="text" id="{{sqlstr.id}}-{{arg}}"/></p>
                {% endfor %}
				<div class="oButton">
                <button type='button' class='btn btn-primary' id="runsql{{forloop.counter}}">运行sql</button>
                 </div>
				<div id="result{{forloop.counter}}">

                </div>
            </div>
            {% endfor %}
            {% endif %}


        </div>

    </div>
</div>
<script>
    
    var url = document.location.toString();
    var arrUrl = url.split("//");

    var start = arrUrl[1].split("/");
    var sqlstrs = {{ sqlstrs| safe}};
    
    base_url = arrUrl[0] + "//" + start[0];

    console.log(base_url);
    console.log('abcdefg')
    console.log(sqlstrs)
    for (var i = 0; i < sqlstrs.length; i++) {
        console.log(sqlstrs[i].sqlname)
    }

    function textAreaEditor(container, options) {
        $('<textarea class="k-textbox" name="' + options.field + '" style="width:100%;height:300px;" />').appendTo(container);
    }
    var copiedrow=false
    var allapps = {{ get_applist | safe }};

    $("#sqlid").kendoGrid({
        editable: 'popup',
        toolbar: ["create", "save", "cancel","search"],
        search: {
            fields: ["app_id","dbname","sqlname","sqlstr","sqldesc","sqlpriv"]
        },
        columns: [
            {
                field: 'app_id',
                values: allapps,
                title: '应用'
            },
            {
                field: 'dbname',
                title: '数据库名称'
            },
            {
                field: 'sqlname',
                title: 'sql名称'
            },
            {
                field: 'sqlstr',
                title: 'sql语句',
                // height: "500px", 
                editor: textAreaEditor,
                
            },
            {
                field: 'sqlpriv',
                title: 'sql权限'
            },
            {
                field: 'sqldesc',
                title: 'sql语句描述'
            },
            {
                title: '操作',
                command: ['edit', 'destroy', 
                    {
                        name: "复制本行",
                        click: function (e) {

                            // prevent page scroll position change
                            e.preventDefault();
                            // e.target is the DOM element representing the button
                            var tr = $(e.target).closest("tr"); // get the current table row (tr)
                            // get the data bound to the current table row
                            newItem = this.dataItem(tr);
                            copiedrow=true
                            this.addRow()

                        }
                    }]
            }
        ],
        edit: function (e) {
            if (e.model.isNew() && copiedrow) {
                // e.sender.closeCell(e.container)
                e.model.set("app_id", newItem.app_id)
                e.model.set("dbname", newItem.dbname)
                e.model.set("sqlname", newItem.sqlname)
                e.model.set("sqlstr", newItem.sqlstr)
                e.model.set("sqlpriv", newItem.sqlpriv)
                e.model.set("sqldesc", newItem.sqldesc)
                copiedrow=false
            }
        },
        dataSource: {
            transport: {
                read: {
                    url: base_url + '/easyops/listing/sqlstatement',
                    dataType: 'json',
                    type: 'GET'
                },
                create: {
                    url: base_url + '/easyops/create/sqlstatement',
                    dataType: 'json',
                    type: 'POST'
                },
                update: {
                    url: base_url + '/easyops/updatelist/sqlstatement',
                    dataType: 'json',
                    type: 'POST'
                },
                destroy: {
                    url: base_url + '/easyops/delete/sqlstatement',
                    dataType: 'json',
                    type: 'POST'
                },

            },
            schema: {
                data: "Data",
                total: "total",
                model: {
                    id: "id",
                    fields: {
                        dbname: {
                            type: "string",
                        },
                        app_id: {
                            type: "string",
                        },
                        sqlname: {
                            type: "string",
                        },
                        sqlstr: {
                            type: "string",
                            validation: {
                                        required: true,
                                        sqlstrvalidation: function (input) {
                                            if (input.is("[name='sqlstr']") && input.val() != "") {
                                                if(/^select.*/i.test(input.val()))
                                                { return true}
                                                else
                                                { alert('Only Select statements allowed');
                                                    return false;
                                                }
                                            }
                                            

                                            return true;
                                        }
                                    }
                        },
                        sqlpriv: {
                            type: "string",
                        },
                        sqldesc: {
                            type: "string",

                        }

                    }
                }
            },

            pageSize: gridpagesize
        },
        sortable: true,
        resizable: true,
        pageable: { numeric: true,
            previousNext: true,
            responsive: false,            
        },

    });

    $.ajaxSetup({
       
    })

    for (var i = 0; i < sqlstrs.length; i++) 
    {
        // alert(sqlstrs[i].sqlstr);
        // alert("#runsql"+sqlstrs[i].id);
        forloopi=i+1
        var isDateField =[];
        $("#runsql"+ forloopi.toString()).kendoButton({
            click: function () {
                // var chosevalue = $(".left-pane li.active").attr('data-id');
                // alert(chosevalue)
                check_session_timeout()
                button_id = event.target.id
                // alert(event.target.id);
                var reg = /\d+/g; 
                chosenvalue = button_id.match(reg)[0]
                chosensqlid=sqlstrs[chosenvalue-1]['id']

                aarg ={}
                for (var j=0;j<sqlstrs[chosenvalue-1].args.length;j++)
                {   
                    aarg[sqlstrs[chosenvalue-1].args[j]]=document.getElementById(chosensqlid+'-'+sqlstrs[chosenvalue-1].args[j]).value; 
                    // alert(JSON.stringify(args))
                }

                $("#result"+chosenvalue).empty();
                $("#result"+chosenvalue).html('正在执行，等待加载结果，请耐心等候。。。')
                
                
                
                $.ajax({
                    // async: false,
                    type: 'POST',
                    url: '/easyops/runsql',
                    data: {
                        'runtype': 1,
                        'sqlid': chosensqlid,
                        'args':JSON.stringify(aarg)
                    },
                    dataType: "json",
                    success: function (result) {
                        // alert(result)
                        if(result['isok']==0)
                        {
                            alert(result['errmsg'])
                            $("#result"+chosenvalue).html('执行失败，错误原因是：'+result['errmsg'])
                        }
                        else
                        { 
                            generateGrid(result);
                        }
                    }
                });

            }

        })
    }

    function generateGrid(response) {
        var model = generateModel(response);
        var columns = generateColumns(response);
        var myDate = new Date();
        var ls_date = myDate.getMinutes().toString()+myDate.getSeconds().toString();
        // alert(myDate.toString().replace(/\s/g,''))
        // alert(ls_date)
        $("#result"+chosenvalue).empty();
        var grid = $("#result"+chosenvalue).kendoGrid({
          toolbar:["excel"],
          excel: {
                fileName: 'result'+chosenvalue+ls_date+".xlsx",
                proxyURL: "https://demos.telerik.com/kendo-ui/service/export",
                filterable: true,
                allPages: true
            },
          dataBound: onDataBound, 
          dataSource: {
            transport:{
              read:  function(options){
                options.success(response.data);
              }
            },

            schema: {
              model: model
            }
          },
          columns: columns,
          pageable: {pageSize: gridpagesize},
          editable:false,
          sortable: true,
          resizable: true,
        });
      }
      function onDataBound()  
        {  
            var grid = $("#result"+ chosenvalue).data("kendoGrid");  
            for (var i = 0; i < grid.columns.length; i++) {  
                grid.autoFitColumn(i);  
            }  
        }  
      function generateColumns(response){
        var columnNames = response["columns"];
        return columnNames.map(function(name){
          return { field: name, format: (isDateField[name] ? "{0:D}" : "") };
        })
      }

      function generateModel(response) {
        var sampleDataItem = response["data"][0];

        var model = {};
        var fields = {};
        for (var property in sampleDataItem) {
          if(property.indexOf("ID") !== -1){
            model["id"] = property;
          }
          var propType = typeof sampleDataItem[property];

          if (propType === "number" ) {
            fields[property] = {
              type: "number",
              validation: {
                required: true
              }
            };
            if(model.id === property){
              fields[property].editable = false;
              fields[property].validation.required = false;
            }
          } else if (propType === "boolean") {
            fields[property] = {
              type: "boolean"
            };
          } else if (propType === "string") {
            fields[property] = {
              type: "string"
            };
          } else {
            fields[property] = {
              validation: {
                required: true
              }
            };
          }
        }

        model.fields = fields;

        return model;
      }






</script>

{% endblock %}